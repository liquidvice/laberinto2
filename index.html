<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Alicia en el Laberinto ‚Äî Completo</title>
<style>
  :root{
    --panel:#111;
    --accent:#8a2be2;
    --white:#ffffff;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:linear-gradient(#0b0b0b,#111);color:#fff;font-family:"Trebuchet MS",sans-serif}
  .wrap{display:flex;flex-direction:column;align-items:center;padding:14px}
  h1{margin:6px 0 8px}
  #scoreboard{margin:6px;font-weight:bold}
  #gameRow{display:flex;gap:16px;align-items:flex-start;position:relative}
  /* spiral background (hidden by default) */
  #spiral {
    position:absolute;
    left:50%;
    top:50%;
    width:1200px;
    height:1200px;
    pointer-events:none;
    transform:translate(-50%,-50%) scale(1);
    border-radius:50%;
    z-index:0;
    mix-blend-mode:screen;
    opacity:0.9;
    display:none;
    filter: blur(30px) saturate(1.2);
    transition:opacity 0.6s ease;
    background:
      conic-gradient(
        red, orange, yellow, lime, cyan, blue, violet, magenta, red
      );
    /* mask it so it looks like a spiral-ish ring (simple) */
    mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 10%, rgba(0,0,0,0) 55%);
    -webkit-mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,1) 10%, rgba(0,0,0,0) 55%);
  }

  /* breathing animation (scale pulse) */
  @keyframes breathe {
    0% { transform: translate(-50%,-50%) scale(1); opacity:0.9; }
    50% { transform: translate(-50%,-50%) scale(1.06); opacity:1; }
    100% { transform: translate(-50%,-50%) scale(1); opacity:0.9; }
  }

  canvas{background:var(--panel);border:3px solid var(--white);display:block;transform-origin:center center;z-index:2}
  #controls{display:flex;flex-direction:column;gap:8px;z-index:3}
  button{padding:8px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,0.6)}
  #finalMessage{margin-top:12px;font-weight:bold;text-align:center}
  #warning{color:yellow;margin-top:6px}
  #enterWonderland{
    display:none;
    margin-top:12px;
    background:linear-gradient(270deg,#ff00ff,#00ffff,#ffcc00,#ff00ff);
    background-size:600% 600%;
    animation:shift 5s linear infinite;
    color:black;padding:10px 18px;border-radius:14px;border:2px solid #fff;font-weight:700;box-shadow:0 0 16px #fff;z-index:3
  }
  @keyframes shift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

  #hud{margin-top:8px;font-size:14px}
  /* responsive */
  @media (max-width:900px){
    canvas{width:90vw;height:90vw}
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>üåÄ Alicia en el Laberinto</h1>
  <div id="scoreboard">Nivel: 1 | Puntaje: 0 | Mejor: 0</div>

  <div id="gameRow">
    <!-- spiral background for level 6 -->
    <div id="spiral"></div>

    <canvas id="mazeCanvas" width="600" height="600"></canvas>

    <div id="controls">
      <button id="btnRestart">Reiniciar</button>
      <button id="btnNew">Nuevo laberinto</button>
      <div id="timer" style="margin-top:8px">Tiempo: 0s</div>
      <div id="warning"></div>
    </div>
  </div>

  <div id="finalMessage"></div>
  <button id="enterWonderland">üåà Entrar al Pa√≠s de las Maravillas üåà</button>
  <div id="hud">
    <span id="scoreDisplay">Puntaje: 0</span> ¬∑ <span id="bestDisplay">Mejor: 0</span>
  </div>
</div>

<script>
/* ------------- Estado global ------------- */
const canvas = document.getElementById('mazeCanvas');
const ctx = canvas.getContext('2d');
const scoreboard = document.getElementById('scoreboard');
const finalMessage = document.getElementById('finalMessage');
const warning = document.getElementById('warning');
const enterBtn = document.getElementById('enterWonderland');
const btnRestart = document.getElementById('btnRestart');
const btnNew = document.getElementById('btnNew');
const timerEl = document.getElementById('timer');
const scoreEl = document.getElementById('scoreDisplay');
const bestEl = document.getElementById('bestDisplay');
const spiralEl = document.getElementById('spiral');

let rows = 10, cols = 10;
let cellSize = 0;
let grid = [];
let player = {x:0,y:0};
let goal = {x:0,y:0};
let teas = [];
let score = 0;
let bestScore = Number(localStorage.getItem('bestScore')||0);
let level = 1;
let maxLevel = 5;
let startTime = null;
let elapsedTime = 0;
let timerInterval = null;

/* Wonderland flags */
let isWonderland = false;
let cheshireInterval = null;
let cheshireVisible = true;
let cheshirePos = null;
let rafId = null;
let rotationAngle = 0;
let rotationSpeed = 0.005; // M√ÅS LENTO: rad/frame (suave)
let rotationSpeedChanger = null;
let disappearing = false;

/* ------------- Maze utilities ------------- */
class Cell {
  constructor(x,y){
    this.x=x; this.y=y;
    this.walls=[true,true,true,true]; // top,right,bottom,left
    this.visited=false;
  }
}
function idx(x,y){
  if(x<0||y<0||x>=cols||y>=rows) return -1;
  return x + y*cols;
}

/* ------------- Maze generation (DFS) ------------- */
function generateMazeDFS(){
  grid.forEach(c=>c.visited=false);
  const stack = [];
  const start = grid[0];
  start.visited = true;
  stack.push(start);
  while(stack.length>0){
    const current = stack[stack.length-1];
    const x = current.x, y = current.y;
    const neighbors = [];
    const top = grid[idx(x,y-1)];
    const right = grid[idx(x+1,y)];
    const bottom = grid[idx(x,y+1)];
    const left = grid[idx(x-1,y)];
    if(top && !top.visited) neighbors.push({cell:top,dir:0});
    if(right && !right.visited) neighbors.push({cell:right,dir:1});
    if(bottom && !bottom.visited) neighbors.push({cell:bottom,dir:2});
    if(left && !left.visited) neighbors.push({cell:left,dir:3});
    if(neighbors.length>0){
      const next = neighbors[Math.floor(Math.random()*neighbors.length)];
      current.walls[next.dir] = false;
      next.cell.walls[(next.dir+2)%4] = false;
      next.cell.visited = true;
      stack.push(next.cell);
    } else {
      stack.pop();
    }
  }
}

/* ------------- Setup & drawing ------------- */
function setupMaze(){
  cellSize = Math.floor(canvas.width / cols);
  grid = [];
  for(let y=0;y<rows;y++){
    for(let x=0;x<cols;x++){
      grid.push(new Cell(x,y));
    }
  }
  player = {x:0,y:0};
  goal = {x:cols-1,y:rows-1};

  // place teas (not on start/goal)
  teas = [];
  const nTeas = Math.max(3, Math.floor(rows/2));
  for(let i=0;i<nTeas;i++){
    let tx,ty;
    do {
      tx = Math.floor(Math.random()*cols);
      ty = Math.floor(Math.random()*rows);
    } while ((tx===player.x && ty===player.y) || (tx===goal.x && ty===goal.y));
    teas.push({x:tx,y:ty});
  }

  generateMazeDFS();

  // reset normal timer (only for levels 1-5)
  if(!isWonderland){
    stopWonderland(); // clean if leftovers
    elapsedTime = 0;
    startTime = Date.now();
    if(timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(()=>{
      elapsedTime = Math.floor((Date.now() - startTime)/1000);
      updateScoreboard();
    },1000);
  }

  drawMazeOnce();
  updateScoreboard();
}

/* draw a single (non-animated) frame or initial frame */
function drawMazeOnce(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(isWonderland){
    ctx.save();
    ctx.translate(canvas.width/2, canvas.height/2);
    ctx.rotate(rotationAngle);
    ctx.translate(-canvas.width/2, -canvas.height/2);
  }

  // walls
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 2;
  for(const c of grid){
    const x = c.x*cellSize, y=c.y*cellSize;
    if(c.walls[0]) drawLine(x,y,x+cellSize,y);
    if(c.walls[1]) drawLine(x+cellSize,y,x+cellSize,y+cellSize);
    if(c.walls[2]) drawLine(x+cellSize,y+cellSize,x,y+cellSize);
    if(c.walls[3]) drawLine(x,y+cellSize,x,y);
  }

  // teas
  ctx.font = `${Math.floor(cellSize*0.55)}px Arial`;
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  for(const t of teas){
    if(isWonderland){
      const alpha = 0.25 + 0.75*Math.abs(Math.sin((Date.now()/100) + (t.x+t.y)));
      ctx.globalAlpha = alpha;
      ctx.fillStyle = (Math.random()>0.5) ? "#ff66ff" : "#66ffea";
    } else {
      ctx.globalAlpha = 1;
      ctx.fillStyle = "#ffff88";
    }
    ctx.fillText("‚òï", t.x*cellSize + cellSize/2, t.y*cellSize + cellSize/2);
  }
  ctx.globalAlpha = 1;

  // player
  ctx.font = `${Math.floor(cellSize*0.75)}px Arial`;
  ctx.fillStyle = "#ffff77";
  ctx.fillText("üë∏", player.x*cellSize + cellSize/2, player.y*cellSize + cellSize/2);

  // goal
  ctx.fillStyle = "#ff4444";
  ctx.fillRect(goal.x*cellSize + cellSize*0.2, goal.y*cellSize + cellSize*0.2, cellSize*0.6, cellSize*0.6);

  // cheshire placeholder (draw only when in wonderland and cheshirePos exists)
  if(isWonderland && cheshirePos && cheshireVisible){
    ctx.font = `${Math.floor(cellSize*0.9)}px Arial`;
    ctx.fillText("üò∏", cheshirePos.x*cellSize + cellSize/2, cheshirePos.y*cellSize + cellSize/2 - (cellSize*0.05));
  }

  if(isWonderland) ctx.restore();
}

/* ------------- Wonderaland animation loop ------------- */
function wonderlandLoop(){
  if(!isWonderland) return;
  // draw frame
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.save();
  ctx.translate(canvas.width/2, canvas.height/2);
  ctx.rotate(rotationAngle);
  ctx.translate(-canvas.width/2, -canvas.height/2);

  // walls
  ctx.strokeStyle = "#fff";
  ctx.lineWidth = 2;
  for(const c of grid){
    const x = c.x*cellSize, y=c.y*cellSize;
    if(c.walls[0]) drawLine(x,y,x+cellSize,y);
    if(c.walls[1]) drawLine(x+cellSize,y,x+cellSize,y+cellSize);
    if(c.walls[2]) drawLine(x+cellSize,y+cellSize,x,y+cellSize);
    if(c.walls[3]) drawLine(x,y+cellSize,x,y);
  }

  // teas (parpadean rapido)
  ctx.font = `${Math.floor(cellSize*0.55)}px Arial`;
  for(const t of teas){
    const alpha = 0.15 + 0.85*Math.abs(Math.sin((Date.now()/80) + (t.x + t.y)));
    ctx.globalAlpha = alpha;
    const color = (Math.random()>0.5) ? "#ff66ff" : "#66ffea";
    ctx.fillStyle = color;
    ctx.fillText("‚òï", t.x*cellSize + cellSize/2, t.y*cellSize + cellSize/2);
  }
  ctx.globalAlpha = 1;

  // player
  ctx.font = `${Math.floor(cellSize*0.75)}px Arial`;
  ctx.fillStyle = "#ffff77";
  ctx.fillText("üë∏", player.x*cellSize + cellSize/2, player.y*cellSize + cellSize/2);

  // goal
  ctx.fillStyle = "lime";
  ctx.fillRect(goal.x*cellSize + cellSize*0.2, goal.y*cellSize + cellSize*0.2, cellSize*0.6, cellSize*0.6);

  // cheshire
  if(cheshirePos && cheshireVisible){
    ctx.font = `${Math.floor(cellSize*0.9)}px Arial`;
    ctx.fillStyle = "#fff";
    ctx.fillText("üò∏", cheshirePos.x*cellSize + cellSize/2, cheshirePos.y*cellSize + cellSize/2 - (cellSize*0.05));
  }

  ctx.restore();

  // rotation increment
  rotationAngle += rotationSpeed;

  // RAF loop
  rafId = requestAnimationFrame(wonderlandLoop);
}

/* ------------- Movement & input ------------- */
function onKeyDownMain(e){
  if(disappearing) return; // if disappearing, ignore input
  let dx=0, dy=0;
  if(e.key === 'ArrowUp') dy = -1;
  if(e.key === 'ArrowDown') dy = 1;
  if(e.key === 'ArrowLeft') dx = -1;
  if(e.key === 'ArrowRight') dx = 1;

  if(isWonderland){
    // inverted controls
    dx = -dx; dy = -dy;
  }

  const cur = grid[idx(player.x, player.y)];
  if(dx===0 && dy===-1 && !cur.walls[0]) player.y--;
  if(dx===1 && dy===0 && !cur.walls[1]) player.x++;
  if(dx===0 && dy===1 && !cur.walls[2]) player.y++;
  if(dx===-1 && dy===0 && !cur.walls[3]) player.x--;

  // clamp
  if(player.x<0) player.x=0;
  if(player.x>cols-1) player.x=cols-1;
  if(player.y<0) player.y=0;
  if(player.y>rows-1) player.y=rows-1;

  // pick teas
  for(let i=teas.length-1;i>=0;i--){
    if(teas[i].x === player.x && teas[i].y === player.y){
      teas.splice(i,1);
      score += 10;
      updateScoreboard();
      // IMPORTANT: previously added time ‚Äî removed as requested
    }
  }

  // reached goal
  if(player.x === goal.x && player.y === goal.y){
    if(teas.length>0){
      warning.innerText = "‚ö†Ô∏è Te faltan tazas por recoger";
      setTimeout(()=> warning.innerText = "", 1600);
    } else {
      if(!isWonderland){
        if(level < maxLevel){
          level++;
          rows += 2; cols += 2;
          setupMaze();
        } else {
          // show the button to enter wonderland
          enterBtn.style.display = 'inline-block';
          finalMessage.innerText = 'Completaste los 5 niveles. ¬øListo para el Pa√≠s de las Maravillas?';
        }
      } else {
        // finished wonderland normally
        stopWonderland();
        finalMessage.innerText = `üéâ ¬°Ganaste el Pa√≠s de las Maravillas! Puntaje: ${score}`;
        if(score > bestScore){ bestScore = score; localStorage.setItem('bestScore', String(bestScore)); updateScoreboard(); }
      }
    }
  }

  if(!isWonderland) drawMazeOnce();
}

/* ------------- Start / Stop wonderland (level 6) ------------- */
function startWonderland(){
  isWonderland = true;
  level = 6;
  rows = 14; cols = 14; // difficulty like level 3
  cellSize = Math.floor(canvas.width / cols);
  setupMaze(); // resets teas, grid, etc.

  // show spiral background and make it breathe
  spiralEl.style.display = 'block';
  spiralEl.style.animation = 'breathe 4s ease-in-out infinite';

  // cheshire initial pos and blinking
  cheshirePos = { x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows) };
  cheshireVisible = true;
  if(cheshireInterval) clearInterval(cheshireInterval);
  cheshireInterval = setInterval(()=>{
    cheshirePos.x = Math.floor(Math.random()*cols);
    cheshirePos.y = Math.floor(Math.random()*rows);
    // toggle visible randomly (appears/disappears)
    cheshireVisible = Math.random() > 0.25; // 75% chance visible each tick
  },1500);

  // rotation speed small / slow and vary a little
  rotationSpeed = 0.003 + Math.random()*0.004; // between 0.003 and 0.007
  if(rotationSpeedChanger) clearInterval(rotationSpeedChanger);
  rotationSpeedChanger = setInterval(()=>{
    rotationSpeed = 0.002 + Math.random()*0.006; // gentle changes
  },1000);

  // start RAF animation
  if(rafId) cancelAnimationFrame(rafId);
  rafId = requestAnimationFrame(wonderlandLoop);

  updateScoreboard();
  finalMessage.innerText = "üåà Entraste al Pa√≠s de las Maravillas üåà";
  enterBtn.style.display = 'none';
}

/* stop and cleanup wonderland */
function stopWonderland(){
  isWonderland = false;
  // clean intervals & RAF
  if(cheshireInterval){ clearInterval(cheshireInterval); cheshireInterval = null; }
  if(rotationSpeedChanger){ clearInterval(rotationSpeedChanger); rotationSpeedChanger = null; }
  if(rafId){ cancelAnimationFrame(rafId); rafId = null; }
  rotationAngle = 0;
  rotationSpeed = 0.005;
  cheshirePos = null;
  cheshireVisible = true;
  disappearing = false;
  spiralEl.style.display = 'none';
  spiralEl.style.animation = '';
  canvas.style.opacity = '1';
}

/* ------------- Helpers & UI ------------- */
function updateScoreboard(){
  scoreboard.innerText = `Nivel: ${level}${isWonderland ? ' (Pa√≠s de las Maravillas)' : ''} | Puntaje: ${score} | Mejor: ${bestScore}`;
  scoreEl.innerText = `Puntaje: ${score}`;
  bestEl.innerText = `Mejor: ${bestScore}`;
  timerEl.innerText = `Tiempo: ${elapsedTime}s`;
}

/* ------------- Drawing helpers ------------- */
function drawLine(x1,y1,x2,y2){
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
}

/* ------------- UI bindings ------------- */
window.addEventListener('keydown', onKeyDownMain);
btnRestart.addEventListener('click', ()=>{
  // full restart
  stopWonderland();
  level = 1;
  rows = 10; cols = 10;
  score = 0;
  finalMessage.innerText = '';
  enterBtn.style.display = 'none';
  setupMaze();
  updateScoreboard();
});
btnNew.addEventListener('click', ()=>{
  setupMaze();
});
enterBtn.addEventListener('click', ()=>{
  enterBtn.style.display = 'none';
  startWonderland();
});

/* ------------- Initialize ------------- */
setupMaze();
updateScoreboard();

</script>
</body>
</html>
